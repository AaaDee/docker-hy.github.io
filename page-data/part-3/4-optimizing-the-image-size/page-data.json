{
    "componentChunkName": "component---src-templates-course-content-template-js",
    "path": "/part-3/4-optimizing-the-image-size",
    "result": {"data":{"page":{"htmlAst":{"type":"element","tagName":"div","properties":{},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"A small image size has many advantages, firstly, it takes much less time to pull a small image from the registry. Another thing is the security: the bigger your image is the larger the surface area for an attack it has."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The following tutorial to \"Building Small Containers\" from Google is an excellent video to showcase the importance of optimizing your Dockerfiles:"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"iframe","properties":{"width":560,"height":315,"src":"https://www.youtube-nocookie.com/embed/wGz_cbtCiEA","frameBorder":"0","allow":"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture","allowFullScreen":true},"children":[]},{"type":"text","value":"\n"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Before going on to the tricks that were shown on the video, let us start start by reducing the number of layers. What actually is a layer? According to the "},{"type":"element","tagName":"a","properties":{"href":"https://docs.docker.com/get-started/overview/#how-does-a-docker-image-work","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"documentation"}]},{"type":"text","value":":"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"To build your own image, you create a Dockerfile with a simple syntax for defining the steps needed to create the image and run it. Each instruction in a Dockerfile creates a layer in the image. When you change the Dockerfile and rebuild the image, only those layers which have changed are rebuilt. This is part of what makes images so lightweight, small, and fast, when compared to other virtualization."}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"So each command that is executed to the base image, forms an layer. The resulting image is the final layer, that combines the changes that all the intrmediate layers contains. Each layer potentially adds something extra to the resulting image so it might be a good idea to minimize the number of layers."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"To keep track of the improvements, we keep on note of the image size after each new Dockerfile."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"dockerfile"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"FROM"}]},{"type":"text","value":" ubuntu:18.04"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"WORKDIR"}]},{"type":"text","value":" /usr/videos"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENV"}]},{"type":"text","value":" LC_ALL=C.UTF-8"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" apt-get update"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" apt-get install -y curl python"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" curl -L https://yt-dl.org/downloads/latest/youtube-dl -o /usr/local/bin/youtube-dl"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" chmod a+x /usr/local/bin/youtube-dl"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" useradd -m appuser"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"USER"}]},{"type":"text","value":" appuser"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENTRYPOINT"}]},{"type":"text","value":" ["},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"/usr/local/bin/youtube-dl\""}]},{"type":"text","value":"]"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"133MB"}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"As was said each command that is executed to the base image, forms an layer. Command here refers to one Dockerfile directice such as "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":". We could now glue all "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" commands together to reduce the number of layers that are created when building the image:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"dockerfile"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"FROM"}]},{"type":"text","value":" ubuntu:18.04"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"WORKDIR"}]},{"type":"text","value":" /usr/videos"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENV"}]},{"type":"text","value":" LC_ALL=C.UTF-8"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" apt-get update && apt-get install -y "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    curl python && "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    curl -L https://yt-dl.org/downloads/latest/youtube-dl -o /usr/local/bin/youtube-dl && "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    chmod a+x /usr/local/bin/youtube-dl && "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    useradd -m appuser"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"USER"}]},{"type":"text","value":" appuser"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENTRYPOINT"}]},{"type":"text","value":" ["},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"/usr/local/bin/youtube-dl\""}]},{"type":"text","value":"]"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"133MB"}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"There is not that much difference, the image with less layers is 2 MB smaller."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"As a sidenote not directly related to Docker: remember that if needed, it is possible to bind packages to versions with "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"curl=1.2.3"}]},{"type":"text","value":" - this will ensure that if the image is built at the later date the image is more likely to work as the versions are exact. On the other hand, the packages will be old and have security issues."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"With "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"docker image history"}]},{"type":"text","value":" we can see that our single "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" layer adds 76.7 megabytes to the image:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ docker image history youtube-dl\n\n  IMAGE          CREATED              CREATED BY                                      SIZE      COMMENT\n  f221975422c3   About a minute ago   /bin/sh -c #(nop)  ENTRYPOINT [\"/usr/local/b…   0B\n  940a7510dc5d   About a minute ago   /bin/sh -c #(nop)  USER appuser                 0B\n  31062eddb851   About a minute ago   /bin/sh -c apt-get update && apt-get install…   76.7MB\n  ..."}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The next step is to remove everything that is not needed in the final image. We don't need the apt source lists anymore, so we can glue the next line to our single "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"RUN"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":".. && \\\nrm -rf /var/lib/apt/lists/*"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now, after we build, the size of the layer is 100 megabytes. We can optimize even further by removing the "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"curl"}]},{"type":"text","value":". We can remove "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"curl"}]},{"type":"text","value":" and all the dependencies it installed with"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":".. && \\\napt-get purge -y --auto-remove curl && \\\nrm -rf /var/lib/apt/lists/*"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"... which brings us down to 94 MB."}]},{"type":"element","tagName":"exercise","properties":{"name":"Exercise 3.6"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Return now back to our "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/docker-hy/material-applications/tree/main/example-frontend","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"frontend"}]},{"type":"text","value":" and\n"},{"type":"element","tagName":"a","properties":{"href":"https://github.com/docker-hy/material-applications/tree/main/example-backend","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" Dockerfile."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Document both image sizes at this point, as was done in the material. Optimize the Dockerfiles of both app, frontend and backend, by joining the RUN commands and removing useless parts."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"After your improvements document the image sizes again. The size difference may not be very much yet."}]}]},{"type":"element","tagName":"h2","properties":{"id":"alpine-linux-variant","style":"position:relative;"},"children":[{"type":"text","value":"Alpine Linux variant"},{"type":"element","tagName":"a","properties":{"href":"#alpine-linux-variant","ariaLabel":"alpine linux variant permalink","className":["anchor","after"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Our Ubuntu base image adds the most megabytes to our image. "},{"type":"element","tagName":"a","properties":{"href":"https://www.alpinelinux.org/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Alpine Linux"}]},{"type":"text","value":" provides a popular alternative base in "},{"type":"element","tagName":"a","properties":{"href":"https://hub.docker.com/_/alpine/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"https://hub.docker.com/_/alpine/"}]},{"type":"text","value":" that is around 4 megabytes. It's based on altenative glibc implementation musl and busybox binaries, so not all software run well (or at all) with it, but our container should run just fine. We'll create the following "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Dockerfile.alpine"}]},{"type":"text","value":" file:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"dockerfile"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"FROM"}]},{"type":"text","value":" alpine:3.13"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"WORKDIR"}]},{"type":"text","value":" /usr/videos"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENV"}]},{"type":"text","value":" LC_ALL=C.UTF-8"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" apk add --no-cache curl python3 ca-certificates && "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    curl -L https://yt-dl.org/downloads/latest/youtube-dl -o /usr/local/bin/youtube-dl && "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    chmod a+x /usr/local/bin/youtube-dl && "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    apk del curl && "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    adduser -D userapp && "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    ln -s /usr/bin/python3 /usr/bin/python"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"USER"}]},{"type":"text","value":" userapp"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENTRYPOINT"}]},{"type":"text","value":" ["},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"/usr/local/bin/youtube-dl\""}]},{"type":"text","value":"]"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"51.7B"}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Notes:"}]},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"The package manager is "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"apk"}]},{"type":"text","value":" and it can work without downloading sources (caches) first with "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"--no-cache"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"useradd"}]},{"type":"text","value":" is missing, but "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"adduser"}]},{"type":"text","value":" exists."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Most of the package names are the same - there's a good package browser at "},{"type":"element","tagName":"a","properties":{"href":"https://pkgs.alpinelinux.org/packages","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"https://pkgs.alpinelinux.org/packages"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"The youtube-dl assumes that Python executable is called "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"python"}]},{"type":"text","value":". When we installed the version 3 of Python, the executable is called "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"python3"}]},{"type":"text","value":" and that is why the last line of the RUN directive makes a "},{"type":"element","tagName":"a","properties":{"href":"https://linuxize.com/post/how-to-create-symbolic-links-in-linux-using-the-ln-command/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"symbolic link"}]},{"type":"text","value":" so that both names can be user to run Python"}]},{"type":"text","value":"\n"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now when we build this file with "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":":alpine-3.13"}]},{"type":"text","value":" as the tag:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ docker build -t youtube-dl:alpine-3.13 -f Dockerfile.alpine ."}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"It seems to run fine:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ docker container run -v \"$(pwd):/usr/videos\" youtube-dl:alpine-3.13 https://imgur.com/JY5tHqr"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"From the history we can see that the our single "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" layer size is 46.3MB"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ docker image history youtube-dl:alpine-3.13\n\n  IMAGE...\n  ...\n  14cfb0b531fb        20 seconds ago         /bin/sh -c apk add --no-cache curl python ca…   46.3MB\n  ...\n\n  <missing>           3 weeks ago         /bin/sh -c #(nop) ADD file:093f0723fa46f6cdb…   5.61MB"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"So in total our Alpine variant is about 52 megabytes, significantly less than our Ubuntu based image."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Back in part 1 we published the Ubuntu version of youtube-dl with tag latest."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We can publish both variants without overriding the other by publishing them with a describing tag:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ docker image tag youtube-dl:alpine-3.13 <username>/youtube-dl:alpine-3.13\n$ docker image push <username>/youtube-dl:alpine-3.13"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"OR, if we don't want to upkeep the Ubuntu version anymore we can replace our Ubuntu image by pushing this as the latest. Someone might depend on the image being Ubuntu though."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ docker image tag youtube-dl:alpine-3.13 <username>/youtube-dl\n$ docker image push <username>/youtube-dl"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Also remember that unless specified the "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":":latest"}]},{"type":"text","value":" tag will always just refer to the latest image build & pushed - that can basically contain anything."}]},{"type":"element","tagName":"exercise","properties":{"name":"Exercise 3.7"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"As you may have guessed, you shall now return back to the example frontend and backend."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Change the base image in FROM to something more suitable. Both should have at least Alpine variants ready in DockerHub. Make sure the application still works after the changes."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Document the size before and after your changes."}]}]},{"type":"element","tagName":"h2","properties":{"id":"multi-stage-builds","style":"position:relative;"},"children":[{"type":"text","value":"Multi-stage builds"},{"type":"element","tagName":"a","properties":{"href":"#multi-stage-builds","ariaLabel":"multi stage builds permalink","className":["anchor","after"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Multi-stage builds are useful when you need some tools just for the build but not for the execution of the image (that is for CMD or ENTRYPOINT). This is an easy way to reduce size in some cases."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Let's create a website with "},{"type":"element","tagName":"a","properties":{"href":"https://jekyllrb.com/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"Jekyll"}]},{"type":"text","value":", build the site for production and serve the static files with Nginx. Start by creating the recipe for Jekyll to build the site."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"dockerfile"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"FROM"}]},{"type":"text","value":" ruby:3"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"WORKDIR"}]},{"type":"text","value":" /usr/app"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" gem install jekyll"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" jekyll new ."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" jekyll build"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This creates a new Jekyll application and builds it. We are going to use Nginx to serve the site page but you can test how the site works if you add the following directive:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"dockerfile"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"CMD"}]},{"type":"text","value":" bundle exec jekyll serve --host 0.0.0.0"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We could start thinking about optimizations at this point but instead we're going add a new FROM for Nginx, this is what resulting image will be. Then we will copy the built static files from the Ruby image to our Nginx image:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"dockerfile"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# the  first stage needs to be given a name"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"FROM"}]},{"type":"text","value":" ruby:3 "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"as"}]},{"type":"text","value":" build-stage"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"WORKDIR"}]},{"type":"text","value":" /usr/app"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" gem install jekyll"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" jekyll new ."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" jekyll build"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# we will now add a new stage"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"FROM"}]},{"type":"text","value":" nginx:1.19-alpine"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"COPY"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","options"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"--from"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"="}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"build-stage"}]}]},{"type":"text","value":" /usr/app/_site/ /usr/share/nginx/html"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now Docker copies contents from the first image "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"/usr/app/_site/"}]},{"type":"text","value":" to "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"/usr/share/nginx/html"}]},{"type":"text","value":" Note the naming from Ruby to "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"build-stage"}]},{"type":"text","value":". We could also use external image as a stage, "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"--from=python:3.7"}]},{"type":"text","value":" for example."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Let's build and check the size difference:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ docker build . -t jekyll\n$ docker image ls\n  REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\n  jekyll              latest              5f8839505f37        37 seconds ago      109MB\n  ruby                latest              616c3cf5968b        28 hours ago        870MB"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"As you can see, even though our Jekyll image needed Ruby during the build stage, its considerably smaller since it only has Nginx and the static files. "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"docker container run -it -p 8080:80 jekyll"}]},{"type":"text","value":" also works as expected."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Often the best choice is to use a FROM "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"scratch"}]},{"type":"text","value":" image as it doesn't have anything we don't explicitly add there, making it most secure option over time."}]},{"type":"element","tagName":"exercise","properties":{"name":"Exercise 3.8: Multi-stage frontend"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Do now a multi-stage build for the example\n"},{"type":"element","tagName":"a","properties":{"href":"https://github.com/docker-hy/material-applications/tree/main/example-frontend","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"frontend"}]},{"type":"text","value":"."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Even though multi-stage builds are designed mostly for binaries in mind, we can leverage the benefits with our frontend project as having original source code with the final assets makes little sense. Build it with the\ninstructions in README and the built assets should be in "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"build"}]},{"type":"text","value":" folder."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"You can still use the "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"serve"}]},{"type":"text","value":" to serve the static files or try out something else."}]}]},{"type":"element","tagName":"exercise","properties":{"name":"Exercise 3.9: Multi-stage backend"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Lets do a multi-stage build for the "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/docker-hy/material-applications/tree/main/example-backend","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"backend"}]},{"type":"text","value":" project since we've come so far with the application."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The project is in golang and building a binary that runs in a container, while straightforward, isn't exactly trivial. Use resources that you have available (Google, example projects) to build the binary and run it inside a container that uses "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"FROM scratch"}]},{"type":"text","value":"."}]},{"type":"element","tagName":"div","properties":{},"children":[{"type":"text","value":"To pass the exercise the image must be smaller than "},{"type":"element","tagName":"b","properties":{},"children":[{"type":"text","value":"25MB"}]},{"type":"text","value":"."}]}]},{"type":"element","tagName":"exercise","properties":{"name":"Exercise 3.10"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Do all or most of the optimizations from security to size for "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"one"}]},{"type":"text","value":" other Dockerfile you have access to, in your own project or for example the ones used in previous \"standalone\" exercises."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Please document Dockerfiles both before and after."}]}]}]},"html":"<div><p>A small image size has many advantages, firstly, it takes much less time to pull a small image from the registry. Another thing is the security: the bigger your image is the larger the surface area for an attack it has.</p><p>The following tutorial to \"Building Small Containers\" from Google is an excellent video to showcase the importance of optimizing your Dockerfiles:</p><p>\n<iframe width=\"560\" height=\"315\" src=\"https://www.youtube-nocookie.com/embed/wGz_cbtCiEA\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>\n</p><p>Before going on to the tricks that were shown on the video, let us start start by reducing the number of layers. What actually is a layer? According to the <a href=\"https://docs.docker.com/get-started/overview/#how-does-a-docker-image-work\" target=\"_blank\" rel=\"noopener noreferrer\">documentation</a>:</p><p><em>To build your own image, you create a Dockerfile with a simple syntax for defining the steps needed to create the image and run it. Each instruction in a Dockerfile creates a layer in the image. When you change the Dockerfile and rebuild the image, only those layers which have changed are rebuilt. This is part of what makes images so lightweight, small, and fast, when compared to other virtualization.</em></p><p>So each command that is executed to the base image, forms an layer. The resulting image is the final layer, that combines the changes that all the intrmediate layers contains. Each layer potentially adds something extra to the resulting image so it might be a good idea to minimize the number of layers.</p><p>To keep track of the improvements, we keep on note of the image size after each new Dockerfile.</p><div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> ubuntu:18.04</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /usr/videos</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> LC_ALL=C.UTF-8</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apt-get update</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apt-get install -y curl python</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> curl -L https://yt-dl.org/downloads/latest/youtube-dl -o /usr/local/bin/youtube-dl</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> chmod a+x /usr/local/bin/youtube-dl</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> useradd -m appuser</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">USER</span> appuser</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ENTRYPOINT</span> [<span class=\"token string\">\"/usr/local/bin/youtube-dl\"</span>]</span></code></pre></div><p><strong>133MB</strong></p><p>As was said each command that is executed to the base image, forms an layer. Command here refers to one Dockerfile directice such as <code class=\"language-text\">RUN</code>. We could now glue all <code class=\"language-text\">RUN</code> commands together to reduce the number of layers that are created when building the image:</p><div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> ubuntu:18.04</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /usr/videos</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> LC_ALL=C.UTF-8</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apt-get update &amp;&amp; apt-get install -y <span class=\"token operator\">\\</span>\n    curl python &amp;&amp; <span class=\"token operator\">\\</span>\n    curl -L https://yt-dl.org/downloads/latest/youtube-dl -o /usr/local/bin/youtube-dl &amp;&amp; <span class=\"token operator\">\\</span>\n    chmod a+x /usr/local/bin/youtube-dl &amp;&amp; <span class=\"token operator\">\\</span>\n    useradd -m appuser</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">USER</span> appuser</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ENTRYPOINT</span> [<span class=\"token string\">\"/usr/local/bin/youtube-dl\"</span>]</span></code></pre></div><p><strong>133MB</strong></p><p>There is not that much difference, the image with less layers is 2 MB smaller.</p><p>As a sidenote not directly related to Docker: remember that if needed, it is possible to bind packages to versions with <code class=\"language-text\">curl=1.2.3</code> - this will ensure that if the image is built at the later date the image is more likely to work as the versions are exact. On the other hand, the packages will be old and have security issues.</p><p>With <code class=\"language-text\">docker image history</code> we can see that our single <code class=\"language-text\">RUN</code> layer adds 76.7 megabytes to the image:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ docker image history youtube-dl\n\n  IMAGE          CREATED              CREATED BY                                      SIZE      COMMENT\n  f221975422c3   About a minute ago   /bin/sh -c #(nop)  ENTRYPOINT [&quot;/usr/local/b…   0B\n  940a7510dc5d   About a minute ago   /bin/sh -c #(nop)  USER appuser                 0B\n  31062eddb851   About a minute ago   /bin/sh -c apt-get update &amp;&amp; apt-get install…   76.7MB\n  ...</code></pre></div><p>The next step is to remove everything that is not needed in the final image. We don't need the apt source lists anymore, so we can glue the next line to our single <code class=\"language-text\">RUN</code></p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">.. &amp;&amp; \\\nrm -rf /var/lib/apt/lists/*</code></pre></div><p>Now, after we build, the size of the layer is 100 megabytes. We can optimize even further by removing the <code class=\"language-text\">curl</code>. We can remove <code class=\"language-text\">curl</code> and all the dependencies it installed with</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">.. &amp;&amp; \\\napt-get purge -y --auto-remove curl &amp;&amp; \\\nrm -rf /var/lib/apt/lists/*</code></pre></div><p>... which brings us down to 94 MB.</p><exercise name=\"Exercise 3.6\"><p>Return now back to our <a href=\"https://github.com/docker-hy/material-applications/tree/main/example-frontend\" target=\"_blank\" rel=\"noopener noreferrer\">frontend</a> and\n<a href=\"https://github.com/docker-hy/material-applications/tree/main/example-backend\" target=\"_blank\" rel=\"noopener noreferrer\">backend</a> Dockerfile.</p><p>Document both image sizes at this point, as was done in the material. Optimize the Dockerfiles of both app, frontend and backend, by joining the RUN commands and removing useless parts.</p><p>After your improvements document the image sizes again. The size difference may not be very much yet.</p></exercise><h2 id=\"alpine-linux-variant\" style=\"position:relative;\">Alpine Linux variant<a href=\"#alpine-linux-variant\" aria-label=\"alpine linux variant permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2><p>Our Ubuntu base image adds the most megabytes to our image. <a href=\"https://www.alpinelinux.org/\" target=\"_blank\" rel=\"noopener noreferrer\">Alpine Linux</a> provides a popular alternative base in <a href=\"https://hub.docker.com/_/alpine/\" target=\"_blank\" rel=\"noopener noreferrer\">https://hub.docker.com/_/alpine/</a> that is around 4 megabytes. It's based on altenative glibc implementation musl and busybox binaries, so not all software run well (or at all) with it, but our container should run just fine. We'll create the following <code class=\"language-text\">Dockerfile.alpine</code> file:</p><div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> alpine:3.13</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /usr/videos</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> LC_ALL=C.UTF-8</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apk add --no-cache curl python3 ca-certificates &amp;&amp; <span class=\"token operator\">\\</span>\n    curl -L https://yt-dl.org/downloads/latest/youtube-dl -o /usr/local/bin/youtube-dl &amp;&amp; <span class=\"token operator\">\\</span>\n    chmod a+x /usr/local/bin/youtube-dl &amp;&amp; <span class=\"token operator\">\\</span>\n    apk del curl &amp;&amp; <span class=\"token operator\">\\</span>\n    adduser -D userapp &amp;&amp; <span class=\"token operator\">\\</span>\n    ln -s /usr/bin/python3 /usr/bin/python</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">USER</span> userapp</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ENTRYPOINT</span> [<span class=\"token string\">\"/usr/local/bin/youtube-dl\"</span>]</span></code></pre></div><p><strong>51.7B</strong></p><p>Notes:</p><ul>\n<li>The package manager is <code class=\"language-text\">apk</code> and it can work without downloading sources (caches) first with <code class=\"language-text\">--no-cache</code>.</li>\n<li><code class=\"language-text\">useradd</code> is missing, but <code class=\"language-text\">adduser</code> exists.</li>\n<li>Most of the package names are the same - there's a good package browser at <a href=\"https://pkgs.alpinelinux.org/packages\" target=\"_blank\" rel=\"noopener noreferrer\">https://pkgs.alpinelinux.org/packages</a>.</li>\n<li>The youtube-dl assumes that Python executable is called <code class=\"language-text\">python</code>. When we installed the version 3 of Python, the executable is called <code class=\"language-text\">python3</code> and that is why the last line of the RUN directive makes a <a href=\"https://linuxize.com/post/how-to-create-symbolic-links-in-linux-using-the-ln-command/\" target=\"_blank\" rel=\"noopener noreferrer\">symbolic link</a> so that both names can be user to run Python</li>\n</ul><p>Now when we build this file with <code class=\"language-text\">:alpine-3.13</code> as the tag:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ docker build -t youtube-dl:alpine-3.13 -f Dockerfile.alpine .</code></pre></div><p>It seems to run fine:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ docker container run -v &quot;$(pwd):/usr/videos&quot; youtube-dl:alpine-3.13 https://imgur.com/JY5tHqr</code></pre></div><p>From the history we can see that the our single <code class=\"language-text\">RUN</code> layer size is 46.3MB</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ docker image history youtube-dl:alpine-3.13\n\n  IMAGE...\n  ...\n  14cfb0b531fb        20 seconds ago         /bin/sh -c apk add --no-cache curl python ca…   46.3MB\n  ...\n\n  &lt;missing&gt;           3 weeks ago         /bin/sh -c #(nop) ADD file:093f0723fa46f6cdb…   5.61MB</code></pre></div><p>So in total our Alpine variant is about 52 megabytes, significantly less than our Ubuntu based image.</p><p>Back in part 1 we published the Ubuntu version of youtube-dl with tag latest.</p><p>We can publish both variants without overriding the other by publishing them with a describing tag:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ docker image tag youtube-dl:alpine-3.13 &lt;username&gt;/youtube-dl:alpine-3.13\n$ docker image push &lt;username&gt;/youtube-dl:alpine-3.13</code></pre></div><p>OR, if we don't want to upkeep the Ubuntu version anymore we can replace our Ubuntu image by pushing this as the latest. Someone might depend on the image being Ubuntu though.</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ docker image tag youtube-dl:alpine-3.13 &lt;username&gt;/youtube-dl\n$ docker image push &lt;username&gt;/youtube-dl</code></pre></div><p>Also remember that unless specified the <code class=\"language-text\">:latest</code> tag will always just refer to the latest image build &#x26; pushed - that can basically contain anything.</p><exercise name=\"Exercise 3.7\"><p>As you may have guessed, you shall now return back to the example frontend and backend.</p><p>Change the base image in FROM to something more suitable. Both should have at least Alpine variants ready in DockerHub. Make sure the application still works after the changes.</p><p>Document the size before and after your changes.</p></exercise><h2 id=\"multi-stage-builds\" style=\"position:relative;\">Multi-stage builds<a href=\"#multi-stage-builds\" aria-label=\"multi stage builds permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2><p>Multi-stage builds are useful when you need some tools just for the build but not for the execution of the image (that is for CMD or ENTRYPOINT). This is an easy way to reduce size in some cases.</p><p>Let's create a website with <a href=\"https://jekyllrb.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Jekyll</a>, build the site for production and serve the static files with Nginx. Start by creating the recipe for Jekyll to build the site.</p><div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> ruby:3</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /usr/app</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> gem install jekyll</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> jekyll new .</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> jekyll build</span></code></pre></div><p>This creates a new Jekyll application and builds it. We are going to use Nginx to serve the site page but you can test how the site works if you add the following directive:</p><div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">CMD</span> bundle exec jekyll serve --host 0.0.0.0</span></code></pre></div><p>We could start thinking about optimizations at this point but instead we're going add a new FROM for Nginx, this is what resulting image will be. Then we will copy the built static files from the Ruby image to our Nginx image:</p><div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token comment\"># the  first stage needs to be given a name</span>\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> ruby:3 <span class=\"token keyword\">as</span> build-stage</span>\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /usr/app</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> gem install jekyll</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> jekyll new .</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> jekyll build</span>\n\n<span class=\"token comment\"># we will now add a new stage</span>\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> nginx:1.19-alpine</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> <span class=\"token options\"><span class=\"token property\">--from</span><span class=\"token punctuation\">=</span><span class=\"token string\">build-stage</span></span> /usr/app/_site/ /usr/share/nginx/html</span></code></pre></div><p>Now Docker copies contents from the first image <code class=\"language-text\">/usr/app/_site/</code> to <code class=\"language-text\">/usr/share/nginx/html</code> Note the naming from Ruby to <em>build-stage</em>. We could also use external image as a stage, <code class=\"language-text\">--from=python:3.7</code> for example.</p><p>Let's build and check the size difference:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ docker build . -t jekyll\n$ docker image ls\n  REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\n  jekyll              latest              5f8839505f37        37 seconds ago      109MB\n  ruby                latest              616c3cf5968b        28 hours ago        870MB</code></pre></div><p>As you can see, even though our Jekyll image needed Ruby during the build stage, its considerably smaller since it only has Nginx and the static files. <code class=\"language-text\">docker container run -it -p 8080:80 jekyll</code> also works as expected.</p><p>Often the best choice is to use a FROM <strong>scratch</strong> image as it doesn't have anything we don't explicitly add there, making it most secure option over time.</p><exercise name=\"Exercise 3.8: Multi-stage frontend\"><p>Do now a multi-stage build for the example\n<a href=\"https://github.com/docker-hy/material-applications/tree/main/example-frontend\" target=\"_blank\" rel=\"noopener noreferrer\">frontend</a>.</p><p>Even though multi-stage builds are designed mostly for binaries in mind, we can leverage the benefits with our frontend project as having original source code with the final assets makes little sense. Build it with the\ninstructions in README and the built assets should be in <code class=\"language-text\">build</code> folder.</p><p>You can still use the <code class=\"language-text\">serve</code> to serve the static files or try out something else.</p></exercise><exercise name=\"Exercise 3.9: Multi-stage backend\"><p>Lets do a multi-stage build for the <a href=\"https://github.com/docker-hy/material-applications/tree/main/example-backend\" target=\"_blank\" rel=\"noopener noreferrer\">backend</a> project since we've come so far with the application.</p><p>The project is in golang and building a binary that runs in a container, while straightforward, isn't exactly trivial. Use resources that you have available (Google, example projects) to build the binary and run it inside a container that uses <code class=\"language-text\">FROM scratch</code>.</p><div>To pass the exercise the image must be smaller than <b>25MB</b>.</div></exercise><exercise name=\"Exercise 3.10\"><p>Do all or most of the optimizations from security to size for <strong>one</strong> other Dockerfile you have access to, in your own project or for example the ones used in previous \"standalone\" exercises.</p><p>Please document Dockerfiles both before and after.</p></exercise></div>","frontmatter":{"path":"/part-3/4-optimizing-the-image-size","title":"Optimizing the image size"},"fileAbsolutePath":"/home/runner/work/docker-hy.github.io/docker-hy.github.io/data/part-3/section-4.md"},"allPages":{"edges":[{"node":{"id":"4352ae37-1cc5-5973-956b-aa3c8cc1a438","frontmatter":{"path":"/faq","title":"Frequently asked questions"}}},{"node":{"id":"e1238e90-e69f-5b89-ae7f-7a3890359b73","frontmatter":{"path":"/frontmatter-guide","title":"Frontmatter-guide"}}},{"node":{"id":"3cb91679-41d9-585e-8746-8d7f0fbc121a","frontmatter":{"path":"/getting-started","title":"Getting started"}}},{"node":{"id":"cc180895-565d-5264-95c9-d15f066c38c3","frontmatter":{"path":"/","title":"About this course"}}},{"node":{"id":"0601dd7a-78da-53bb-9402-15fadc681ddc","frontmatter":{"path":"/links","title":"Links"}}},{"node":{"id":"6c9405c1-39a6-56b2-934e-33850f881070","frontmatter":{"path":"/part-1","title":"Part 1"}}},{"node":{"id":"c5438964-0c78-52f9-b28f-f73711d88666","frontmatter":{"path":"/part-1/1-getting-started","title":"Definitions and basic concepts"}}},{"node":{"id":"a8076827-affa-555a-b777-dba87c8e257f","frontmatter":{"path":"/part-1/2-running-and-stopping","title":"Running and stopping containers"}}},{"node":{"id":"d1d17462-978a-5516-8207-0fff56d3d301","frontmatter":{"path":"/part-1/3-in-depth-dive-to-images","title":"In-depth dive to images"}}},{"node":{"id":"b86409c3-2663-57ce-9a34-5ba818f8c6f7","frontmatter":{"path":"/part-1/4-defining-start-conditions","title":"Defining start conditions for the container"}}},{"node":{"id":"f0602d39-4b70-5d33-81a1-44c74bc6a963","frontmatter":{"path":"/part-1/5-volumes-and-ports","title":"Interacting with the container via volumes and ports"}}},{"node":{"id":"eb754b3f-0629-5970-a322-6a4dc4564d67","frontmatter":{"path":"/part-1/6-docker-hub","title":"Utilizing tools from the Registry"}}},{"node":{"id":"d1c71e59-47d3-54fd-a486-383c8377fe36","frontmatter":{"path":"/part-1/7-summary","title":"Summary"}}},{"node":{"id":"0c108910-d460-5d9b-8099-772363806cd1","frontmatter":{"path":"/part-2","title":"Part 2"}}},{"node":{"id":"5ecd7aff-3a9d-5952-a0e4-50e15971e6be","frontmatter":{"path":"/part-2/1-migrating-to-docker-compose","title":"Migrating to Docker Compose"}}},{"node":{"id":"4007819b-0805-5da6-bf6a-99ded7c679ba","frontmatter":{"path":"/part-2/2-docker-networking","title":"Docker networking"}}},{"node":{"id":"663340ff-6dff-50cc-9bb2-25940e07ee07","frontmatter":{"path":"/part-2/3-volumes-in-action","title":"Volumes in action"}}},{"node":{"id":"d765d5bb-ef50-576a-8818-9938b2930e71","frontmatter":{"path":"/part-2/5-summary","title":"Summary"}}},{"node":{"id":"562b2219-bfee-5004-b19d-67666caa20c1","frontmatter":{"path":"/part-3","title":"Part 3"}}},{"node":{"id":"a43415c2-1067-541e-83ce-30fbd4938a64","frontmatter":{"path":"/part-3/1-deeper-understainding-of-containers","title":"Official Images and trust"}}},{"node":{"id":"f13c2ceb-97e3-50e6-9153-9fd8c7b4eb5a","frontmatter":{"path":"/part-3/2-deployment-pipelines","title":"Deployment pipelines"}}},{"node":{"id":"baa5a147-830d-5a73-b883-2eef8b123a54","frontmatter":{"path":"/part-3/3-using-non-root-user","title":"Using a non-root user"}}},{"node":{"id":"fccc6c0d-db88-5605-9dcf-032a5afa0c28","frontmatter":{"path":"/part-2/4-containers-in-development","title":"Containers in development"}}},{"node":{"id":"b172f390-4ffa-568d-99e8-737985f35a70","frontmatter":{"path":"/part-3/4-optimizing-the-image-size","title":"Optimizing the image size"}}},{"node":{"id":"76657527-40ce-5179-88b3-0df3d0ae2ab9","frontmatter":{"path":"/part-3/5-multi-host-environments","title":"Multi-host environments"}}},{"node":{"id":"3405a024-ea45-5fd0-8004-ec8726591ee1","frontmatter":{"path":"/part-3/6-end","title":"End"}}}]}},"pageContext":{}},
    "staticQueryHashes": ["3294351120","994120085"]}